From 444566ea6cfd2b8c0cbc49682f610b9d176d8ab9 Mon Sep 17 00:00:00 2001
From: Khem Raj <raj.khem@gmail.com>
Date: Fri, 8 Jun 2018 20:38:30 -0700
Subject: [PATCH] Add configure check for canonicalize_file_name() before use

Define canonicalize_file_name API if not provided by system C library
musl e.g. does not provide this API

Signed-off-by: Khem Raj <raj.khem@gmail.com>
Upstream-Status: Pending

---
 configure.ac                                |  2 ++
 src/kerneldevice/mm-kernel-device-generic.c | 19 +++++++++++++++++++
 2 files changed, 21 insertions(+)

diff --git a/configure.ac b/configure.ac
index 94140df..cb58b95 100644
--- a/configure.ac
+++ b/configure.ac
@@ -72,6 +72,8 @@ AC_SUBST(MM_GLIB_LT_CURRENT)
 AC_SUBST(MM_GLIB_LT_REVISION)
 AC_SUBST(MM_GLIB_LT_AGE)
 
+AC_CHECK_FUNCS([canonicalize_file_name])
+
 dnl-----------------------------------------------------------------------------
 dnl Documentation
 dnl
diff --git a/src/kerneldevice/mm-kernel-device-generic.c b/src/kerneldevice/mm-kernel-device-generic.c
index 53cd737..db08352 100644
--- a/src/kerneldevice/mm-kernel-device-generic.c
+++ b/src/kerneldevice/mm-kernel-device-generic.c
@@ -23,6 +23,7 @@
 
 #include <ModemManager-tags.h>
 
+#include "config.h"
 #include "mm-kernel-device-generic.h"
 #include "mm-kernel-device-generic-rules.h"
 #include "mm-log.h"
@@ -103,6 +104,24 @@ read_sysfs_property_as_string (const gchar *path,
     return contents;
 }
 
+#ifndef HAVE_CANONICALIZE_FILE_NAME
+#include <limits.h>
+#include <string.h>
+#include <stdlib.h>
+#include <stdio.h>
+static char * canonicalize_file_name(const char *path)
+{
+   char buf[PATH_MAX] = { };
+
+   snprintf(buf, sizeof(buf) - 1, "%s", path);
+
+   if (!realpath(path, buf))
+       return NULL;
+
+   return strdup(buf);
+}
+#endif
+
 /*****************************************************************************/
 /* Load contents */
 
