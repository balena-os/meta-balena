#!/bin/sh

#
# Script which configures the grub.cfg to use an updated root index
#

set -o errexit

DURING_UPDATE=${DURING_UPDATE:-0}

if [ "$DURING_UPDATE" = "1" ]; then
	SYSROOT="/mnt/sysroot/inactive"
else
	SYSROOT="/mnt/sysroot/active"
fi

new_part=$(findmnt --noheadings --canonicalize --output SOURCE $SYSROOT)
new_part_label=$(blkid "$new_part" | awk '{print $2}')

printf "[INFO] Switching root partition to %s..." "$new_part_label..."
sed "s/root=[^ ]* /"root=$new_part_label" /" /mnt/boot/EFI/BOOT/grub.cfg > /mnt/boot/EFI/BOOT/grub.cfg.new

sync -f /mnt/boot/EFI/BOOT
mv /mnt/boot/EFI/BOOT/grub.cfg.new /mnt/boot/EFI/BOOT/grub.cfg
sync -f /mnt/boot/EFI/BOOT
printf " done.\n"
