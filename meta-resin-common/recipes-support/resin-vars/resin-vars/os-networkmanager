#!/bin/bash

. /usr/sbin/resin-vars

keys=$(jq -r 'select(.os != null) | select(.os.networkManager != null) | .os.networkManager | keys[] ' "$CONFIG_PATH")
lscmd="ls -I README"

remove_extra_files() {
	lscmd="$lscmd /etc/NetworkManager/conf.d"
	extra_confs=$(eval "$lscmd")
	for extra_conf in $extra_confs; do
		echo "Removing extra conf: $extra_conf"
		rm "/etc/NetworkManager/conf.d/$extra_conf"
	done
}

if [ ! -z "$keys" ]; then
	echo "Found custom config fragments in $CONFIG_PATH"
	while read -r key; do
		echo "Found custom config fragment: $key"
		lscmd="$lscmd -I \"$key.conf\""
		filter="'.os.networkManager.\"$key\"'"
		cmd="jq -r $filter $CONFIG_PATH"
		conf=$(eval "$cmd")
		if [ -f "/etc/NetworkManager/conf.d/$key.conf" ] && [ "$(cat "/etc/NetworkManager/conf.d/$key.conf")" = "$conf" ]; then
			echo "/etc/NetworkManager/conf.d/$key.conf already exists"
			continue
		else
			echo "New config fragment or modified fragment detected. Writing /etc/NetworkManager/conf.d/$key.conf"
			echo "$conf" > "/etc/NetworkManager/conf.d/$key.conf"
		fi
	done <<< "$keys"

	if [ ! -f /etc/NetworkManager/conf.d/README ]; then
		echo "Files here are auto-generated by os-networkmanager. Extra files will be removed" >> /etc/NetworkManager/conf.d/README
	fi

	remove_extra_files
	echo "All config fragments from config.json present in /etc/NetworkManager/conf.d"
else
	remove_extra_files
	echo "No custom config fragments found in $CONFIG_PATH"
fi
