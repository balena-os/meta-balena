From: Alex Gonzalez <alexg@balena.io>
Date: Wed, 3 Jul 2024 10:57:03 +0200
Subject: [PATCH] CVE-2024-6387

Race condition that can lead to sshd to handle some signals in an unsafe
manner. An unauthenticated, remote attacker may be able to trigger it by
failing to authenticate within a set time period.

Addressed upstream in OpenSSH 9.8
https://www.openwall.com/lists/oss-security/2024/07/01/1

Upstream-status: Backport [https://www.openwall.com/lists/oss-security/2024/07/01/2]
CVE: CVE-2024-6387
Signed-off-by: Alex Gonzalez <alexg@balena.io>
---
 log.c | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/log.c b/log.c
index 99bf046a792a..10e41bde7dd7 100644
--- a/log.c
+++ b/log.c
@@ -451,12 +451,14 @@ void
 sshsigdie(const char *file, const char *func, int line, int showfunc,
     LogLevel level, const char *suffix, const char *fmt, ...)
 {
+#ifdef SYSLOG_R_SAFE_IN_SIGHAND
 	va_list args;
 
 	va_start(args, fmt);
 	sshlogv(file, func, line, showfunc, SYSLOG_LEVEL_FATAL,
 	    suffix, fmt, args);
 	va_end(args);
+#endif
 	_exit(1);
 }
 
