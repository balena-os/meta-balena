From 769063f71738e98f88c34494af0cdaf8aadcf81b Mon Sep 17 00:00:00 2001
From: Will Newton <willn@resin.io>
Date: Tue, 13 Jun 2017 13:47:09 +0100
Subject: [PATCH] tar: Fix parsing of tar archives generated by docker

This is a backport of 9655f95d0f501b03b33c7896b7b0c23d090aff81
from busybox 1.26.1

Upstream-Status: Backport
---
 archival/libarchive/get_header_tar.c | 20 ++++++++++++++------
 1 file changed, 14 insertions(+), 6 deletions(-)

diff --git a/archival/libarchive/get_header_tar.c b/archival/libarchive/get_header_tar.c
index fb68673..16e5665 100644
--- a/archival/libarchive/get_header_tar.c
+++ b/archival/libarchive/get_header_tar.c
@@ -105,11 +105,19 @@ static void process_pax_hdr(archive_handle_t *archive_handle, unsigned sz, int g
 		value = end + 1;
 
 #if ENABLE_FEATURE_TAR_GNU_EXTENSIONS
-		if (!global && is_prefixed_with(value, "path=")) {
-			value += sizeof("path=") - 1;
-			free(archive_handle->tar__longname);
-			archive_handle->tar__longname = xstrdup(value);
-			continue;
+		if (!global) {
+			if (strncmp(value, "path=", sizeof("path=") - 1) == 0) {
+				value += sizeof("path=") - 1;
+				free(archive_handle->tar__longname);
+				archive_handle->tar__longname = xstrdup(value);
+				continue;
+			}
+			if (strncmp(value, "linkpath=", sizeof("linkpath=") - 1) == 0) {
+				value += sizeof("linkpath=") - 1;
+				free(archive_handle->tar__linkname);
+				archive_handle->tar__linkname = xstrdup(value);
+				continue;
+			}
 		}
 #endif
 
@@ -186,7 +194,7 @@ char FAST_FUNC get_header_tar(archive_handle_t *archive_handle)
 	archive_handle->offset += i;
 
 	/* If there is no filename its an empty header */
-	if (tar.name[0] == 0 && tar.prefix[0] == 0) {
+	if (tar.name[0] == 0 && tar.prefix[0] == 0 && !p_longname) {
 		if (archive_handle->tar__end) {
 			/* Second consecutive empty header - end of archive.
 			 * Read until the end to empty the pipe from gz or bz2
-- 
2.9.4

