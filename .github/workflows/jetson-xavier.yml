name: Nvidia Jetson Xavier AGX

on:
  pull_request:
    branches:
      - main
      - master
      # ESR branches glob pattern
      - "[0-9]+.[0-9]+.x"
  pull_request_target:
    branches:
      - main
      - master
      # ESR branches glob pattern
      - "[0-9]+.[0-9]+.x"

jobs:
  yocto:
    name: Yocto
    uses: balena-os/balena-yocto-scripts/.github/workflows/yocto-build-deploy.yml@7571c6cc181cd909439d1364fb05c8e1d987a048 # v1.25.63
    # Prevent duplicate workflow executions for pull_request (PR) and pull_request_target (PRT) events.
    # Both PR and PRT will be triggered for the same pull request, whether it is internal or from a fork.
    # This condition will prevent the workflow from running twice for the same pull request while
    # still allowing it to run for all other event types.
    if: (github.event.pull_request.head.repo.full_name == github.repository) == (github.event_name == 'pull_request')
    secrets: inherit
    with:
      # Needed for testing - defaults to production
      deploy-environment: balena-staging.com
      machine: jetson-xavier
      device-repo: balena-os/balena-jetson
      device-repo-ref: master
      # Pin to the current commit
      meta-balena-ref: ${{ github.sha }}
